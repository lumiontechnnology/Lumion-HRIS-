<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumion HR — Analytics (Offline AI Prototype)</title>
  <link rel="icon" href="https://i.ibb.co/XfRLzWwy/Logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 6px 24px rgba(15,23,42,0.06); }
    .chat-bubble { padding:10px 14px; border-radius:12px; max-width:80%; }
    .chat-ai { background:#F3F4F6; color:#111827; align-self:flex-start; }
    .chat-user { background:#4F46E5; color:white; align-self:flex-end; }
    #chatWindow { display:flex; flex-direction:column; gap:8px; width:420px; position:fixed; right:20px; bottom:20px; z-index:60; }
    #chatMessages { padding:12px; max-height:360px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .pill { padding:6px 10px; border-radius:999px; font-size:12px; }
    @media (max-width:900px){ #chatWindow{ right:10px; width:90vw } }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="bg-white border-b sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="https://i.ibb.co/XfRLzWwy/Logo.png" alt="Lumion" class="h-10 w-auto"/>
        <div>
          <div class="text-lg font-semibold">Lumion HR — Analytics (Offline AI)</div>
          <div class="text-xs text-gray-500">Prototype — Local data & rule-based AI</div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <button id="downloadData" class="px-3 py-2 bg-indigo-600 text-white rounded">Export data</button>
        <button id="resetData" class="px-3 py-2 border rounded">Reset Demo</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
      <div class="card p-5">
        <div class="text-sm text-gray-500">Employees</div>
        <div class="mt-2 text-2xl font-bold" id="kEmployees">0</div>
        <div class="text-xs text-green-600 mt-1">sample dataset</div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-gray-500">Turnover (YTD)</div>
        <div class="mt-2 text-2xl font-bold" id="kTurnover">0%</div>
        <div class="text-xs text-gray-500 mt-1">by headcount</div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-gray-500">Avg Engagement</div>
        <div class="mt-2 text-2xl font-bold" id="kEngagement">0%</div>
        <div class="text-xs text-gray-500 mt-1">pulse score</div>
      </div>
      <div class="card p-5">
        <div class="text-sm text-gray-500">Avg Time-to-hire</div>
        <div class="mt-2 text-2xl font-bold" id="kTTH">0 days</div>
        <div class="text-xs text-gray-500 mt-1">simulated</div>
      </div>
    </section>

    <section class="grid lg:grid-cols-3 gap-6 mb-6">
      <div class="card p-4 lg:col-span-2">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-semibold">Predictive Overview</h3>
          <div class="text-sm text-gray-500">Rule-based insights · Offline</div>
        </div>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <canvas id="turnoverChart" height="160"></canvas>
          </div>
          <div>
            <canvas id="engagementChart" height="160"></canvas>
          </div>
          <div class="md:col-span-2 mt-4">
            <canvas id="attritionRiskChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <aside class="card p-4">
        <h4 class="font-semibold">Quick Insights</h4>
        <div id="quickInsights" class="mt-3 text-sm text-gray-700 space-y-2"></div>
        <hr class="my-4">
        <h5 class="text-sm font-semibold">Suggested queries</h5>
        <div class="mt-2 flex flex-col gap-2">
          <button class="pill bg-indigo-50 text-indigo-700" onclick="ask('Which department has the highest attrition?')">Which department has highest attrition?</button>
          <button class="pill bg-indigo-50 text-indigo-700" onclick="ask('Who is at risk of leaving?')">Who is at risk of leaving?</button>
          <button class="pill bg-indigo-50 text-indigo-700" onclick="ask('Show time-to-hire and cost-per-hire')">Time-to-hire & cost-per-hire</button>
          <button class="pill bg-indigo-50 text-indigo-700" onclick="ask('Show engagement trend last 6 months')">Engagement trend</button>
        </div>
      </aside>
    </section>

    <section class="grid lg:grid-cols-2 gap-6">
      <div class="card p-4">
        <h4 class="font-semibold">Employee Directory (sample)</h4>
        <div class="overflow-auto mt-3" style="max-height:320px">
          <table class="w-full text-sm" id="dirTable">
            <thead class="text-xs text-gray-500">
              <tr>
                <th class="p-2 text-left">Name</th><th class="p-2">Dept</th><th class="p-2">Eng</th><th class="p-2">Tenure</th><th class="p-2">Status</th>
              </tr>
            </thead>
            <tbody id="dirBody"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-4">
        <h4 class="font-semibold">Ask HR (Offline Conversational AI)</h4>
        <p class="text-xs text-gray-500 mt-1">Type any HR question — the local agent uses heuristics on the mock data to reply.</p>
        <div class="mt-3">
          <input id="askInput" placeholder="Ask e.g., Who is at risk of leaving?" class="w-full p-2 border rounded" />
          <div class="mt-2 flex gap-2">
            <button id="askBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Ask</button>
            <button id="clearBtn" class="px-3 py-2 border rounded">Clear</button>
          </div>
        </div>

        <div id="convo" class="mt-3 p-3 border rounded" style="min-height:180px; overflow:auto; max-height:360px;"></div>
      </div>
    </section>

    <section class="mt-6 card p-4">
      <h4 class="font-semibold">Advanced: View / Export Mock Tables</h4>
      <div class="mt-3 text-sm text-gray-600">You can export the employees or jobs tables for prototyping in Airtable or CSV.</div>
      <div class="mt-3 flex gap-3">
        <button id="exportEmployees" class="px-3 py-2 border rounded">Export Employees CSV</button>
        <button id="exportJobs" class="px-3 py-2 border rounded">Export Jobs CSV</button>
      </div>
    </section>

  </main>

  <!-- Floating chat -->
  <div id="chatWindow" aria-hidden="false" class="hidden">
    <div id="chatMessages"></div>
    <div style="display:flex;gap:8px;padding:10px;border-top:1px solid #eee">
      <input id="chatBox" class="flex-1 p-2 border rounded" placeholder="Ask Lumion Assistant..." />
      <button id="chatSend" class="px-3 py-2 bg-indigo-600 text-white rounded">Send</button>
    </div>
  </div>

<script>
/* -------------------------
   MOCK DATA (employees & jobs)
   - You can expand or modify
--------------------------*/
const MOCK = (function genMock(){
  const depts = ["Engineering","Sales","HR","Product","Finance","Design","Customer Success","Operations","Legal","Marketing"];
  const roles = {
    "Engineering":["Frontend Engineer","Backend Engineer","DevOps","QA"],
    "Sales":["Sales Rep","Account Exec","Sales Lead"],
    "HR":["HRBP","Recruiter","HR Manager"],
    "Product":["Product Manager","Data Analyst"],
    "Finance":["Finance Manager","Payroll Exec"],
    "Design":["UI/UX Designer","Motion Designer"],
    "Customer Success":["CS Rep","CS Manager"],
    "Operations":["Ops Lead"],
    "Legal":["Legal Counsel"],
    "Marketing":["Social Manager","Growth"]
  };
  const names = ["Ada Bello","Chike Okoro","Ifeanyi N.","Nkechi U.","James A.","Seyi O.","Amaka P.","Tunde R.","Zainab K.","Michael L.","Fatima U.","Peter N.","Rose M.","David O.","Sade A.","Bayo K.","Ngozi C.","Umar B.","Lilian T.","Joel A."];
  // expand to ~60 employees by combining
  const employees=[];
  for(let i=0;i<80;i++){
    const name = names[i % names.length] + (i>19?(" "+(Math.floor(i/20))):"");
    const dept = depts[i % depts.length];
    const rolelist = roles[dept] || ["Staff"];
    const role = rolelist[Math.floor(Math.random()*rolelist.length)];
    const salary = Math.round((Math.random()*200 + 80) * 1000); // ₦80k-₦280k
    const startMonths = Math.floor(Math.random()*84); // up to 7 years
    const start = new Date(); start.setMonth(start.getMonth() - startMonths);
    const tenureMonths = Math.max(1, startMonths);
    const engagement = Math.round(Math.max(40, Math.min(100, 70 + (Math.random()*20 - 10)))); // 50-90 approx
    const performanceTrend = Math.round(Math.max(1, Math.min(5, 3 + (Math.random()*2 - 1)))); // 1-5
    const gender = Math.random() > 0.5 ? "F" : "M";
    const absenteeism = Math.round(Math.random()*6); // days/month
    const onLeave = Math.random() < 0.06 ? "On Leave" : "Active";
    const promotionReady = (performanceTrend >=4 && engagement >=75 && tenureMonths>12) ? true : false;
    employees.push({
      id: "EMP"+String(1000+i),
      name, dept, role, salary, start: start.toISOString().slice(0,10),
      tenureMonths, engagement, performanceTrend, gender, absenteeism, status: onLeave, promotionReady
    });
  }

  // hires / jobs
  const jobs = [
    { id:"JOB001", title:"Frontend Engineer", team:"Engineering", openDate:"2025-08-01", timeToHire:24, costPerHire:120000, sourceStats:{LinkedIn:8,Indeed:3,Referral:2}},
    { id:"JOB002", title:"HR Manager", team:"HR", openDate:"2025-07-10", timeToHire:30, costPerHire:150000, sourceStats:{LinkedIn:5,Indeed:4}},
    { id:"JOB003", title:"Product Manager", team:"Product", openDate:"2025-06-15", timeToHire:45, costPerHire:250000, sourceStats:{LinkedIn:6,Referral:1}},
    { id:"JOB004", title:"Backend Engineer", team:"Engineering", openDate:"2025-08-05", timeToHire:28, costPerHire:130000, sourceStats:{LinkedIn:7,Indeed:1}},
    { id:"JOB005", title:"Sales Executive", team:"Sales", openDate:"2025-07-03", timeToHire:18, costPerHire:90000, sourceStats:{LinkedIn:4,Indeed:3}},
    { id:"JOB006", title:"Data Analyst", team:"Product", openDate:"2025-09-01", timeToHire:20, costPerHire:110000, sourceStats:{LinkedIn:3,Indeed:2}}
  ];

  // simulated historical metrics for 6 months
  const months = [];
  for(let m=5;m>=0;m--){
    const d = new Date(); d.setMonth(d.getMonth()-m);
    months.push(d.toLocaleString('default',{month:'short', year:'numeric'}));
  }
  const engagementHistory = months.map((_,i)=> Math.round(72 + (Math.sin(i/2)*4) + (Math.random()*3 - 1.5)));
  const turnoverHistory = months.map((_,i) => Math.round(2 + Math.max(0, Math.random()*3 + (i*0.5))));
  const absenteeHistory = months.map((_,i) => Math.round(1 + Math.random()*2 + (i*0.2)));

  return { employees, jobs, months, engagementHistory, turnoverHistory, absenteeHistory };
})();

/* -------------------------
   Utility & Metrics functions
--------------------------*/
function pct(v, decimals=1){ return (Math.round(v*10)/10).toFixed(decimals); }
function computeTurnover(){
  // simple: number of employees who started within last 12 months and left simulated? We'll just compute % of employees with tenure < 6 months leaving rate simulated
  const total = MOCK.employees.length;
  // simulate attritions last 12 months: sample proportion from turnoverHistory
  const recent = MOCK.turnoverHistory.reduce((a,b)=>a+b,0);
  const rate = Math.round((recent / (total || 1)) * 100);
  return rate;
}
function avgEngagement(){
  const e = MOCK.employees.reduce((s,emp)=>s+emp.engagement,0)/MOCK.employees.length;
  return Math.round(e);
}
function avgTimeToHire(){
  const t = MOCK.jobs.reduce((s,j)=>s+j.timeToHire,0)/MOCK.jobs.length;
  return Math.round(t);
}
function topAttritionDept(){
  // naive: dept with highest simulated "risk" = lower engagement + many with low tenure
  const deptStats = {};
  MOCK.employees.forEach(emp=>{
    if(!deptStats[emp.dept]) deptStats[emp.dept]={count:0,eng:0,lowTenure:0};
    deptStats[emp.dept].count++;
    deptStats[emp.dept].eng += emp.engagement;
    if(emp.tenureMonths <=6) deptStats[emp.dept].lowTenure++;
  });
  const ranks = Object.entries(deptStats).map(([d,s])=>{
    const avgEng = s.eng/s.count;
    const score = (100 - avgEng) + (s.lowTenure/s.count*40);
    return { dept:d, score: Math.round(score), avgEng: Math.round(avgEng), lowTenure: s.lowTenure };
  }).sort((a,b)=>b.score-a.score);
  return ranks[0] || {dept:'—',score:0};
}
function atRiskEmployees(limit=8){
  // at-risk if engagement < 60 or performanceTrend <=2 and tenure < 24 or absenteeism high
  const list = MOCK.employees.filter(e=>{
    const riskScore = (60 - e.engagement) + (e.performanceTrend <=2 ? 10 : 0) + (e.absenteeism > 3 ? 8 : 0) + (e.tenureMonths < 6 ? 6 : 0);
    return riskScore > 10; // threshold
  }).sort((a,b)=> (a.engagement - b.engagement) || (b.absenteeism - a.absenteeism));
  return list.slice(0,limit);
}
function topPerformers(limit=5){
  return MOCK.employees.sort((a,b)=> (b.performanceTrend - a.performanceTrend) || (b.engagement - a.engagement)).slice(0,limit);
}
function trainingEffectivenessSim(){
  // simulated: training hours vs performance improvement
  return [
    { program:"Engineering Bootcamp", participants:24, impact: Math.round(12 + Math.random()*10) },
    { program:"Sales Enablement", participants:18, impact: Math.round(8 + Math.random()*12) },
    { program:"Leadership 101", participants:10, impact: Math.round(6 + Math.random()*8) },
  ];
}

/* -------------------------
   Render charts & UI
--------------------------*/
let turnoverChart, engagementChart, riskChart;

function renderKPIs(){
  document.getElementById('kEmployees').textContent = MOCK.employees.length;
  document.getElementById('kTurnover').textContent = computeTurnover() + '%';
  document.getElementById('kEngagement').textContent = avgEngagement() + '%';
  document.getElementById('kTTH').textContent = avgTimeToHire() + ' days';
}

function renderCharts(){
  const ctx1 = document.getElementById('turnoverChart').getContext('2d');
  const ctx2 = document.getElementById('engagementChart').getContext('2d');
  const ctx3 = document.getElementById('attritionRiskChart').getContext('2d');

  if(turnoverChart) turnoverChart.destroy();
  if(engagementChart) engagementChart.destroy();
  if(riskChart) riskChart.destroy();

  turnoverChart = new Chart(ctx1, {
    type:'bar',
    data:{ labels: MOCK.months, datasets:[{ label:'Turnover (headcount)', data: MOCK.turnoverHistory, backgroundColor:'#ef4444' }]},
    options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
  });
  engagementChart = new Chart(ctx2, {
    type:'line',
    data:{ labels:MOCK.months, datasets:[{label:'Engagement', data:MOCK.engagementHistory, borderColor:'#4F46E5', backgroundColor:'rgba(79,70,229,0.08)', fill:true}]},
    options:{plugins:{legend:{display:false}}, scales:{y:{min:40,max:100}}}
  });

  // attrition risk distribution by dept
  const depts = [...new Set(MOCK.employees.map(e=>e.dept))].slice(0,8);
  const deptRisk = depts.map(d=>{
    const emps = MOCK.employees.filter(e=>e.dept===d);
    const avgEng = emps.reduce((s,e)=>s+e.engagement,0)/emps.length;
    const risk = Math.max(0, Math.round((80 - avgEng) / 8 * 10));
    return risk;
  });
  riskChart = new Chart(ctx3, {
    type:'horizontalBar',
    data:{ labels:depts, datasets:[{ label:'Risk', data:deptRisk, backgroundColor:'#f59e0b' }]},
    options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true, max:100}}}
  });
}

function renderDirectory(){
  const body = document.getElementById('dirBody');
  body.innerHTML = "";
  MOCK.employees.slice(0,80).forEach(emp=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="p-2">${emp.name}</td><td class="p-2">${emp.dept}</td><td class="p-2 text-center">${emp.engagement}%</td><td class="p-2 text-center">${Math.round(emp.tenureMonths/12)}y</td><td class="p-2 text-center">${emp.status}</td>`;
    body.appendChild(tr);
  });
}

function renderQuickInsights(){
  const el = document.getElementById('quickInsights');
  const top = topAttritionDept();
  const atRisk = atRiskEmployees(5);
  el.innerHTML = `
    <div>• Dept at highest likely attrition: <strong>${top.dept}</strong> (est. risk score ${top.score})</div>
    <div>• Employees at risk (top 5): <strong>${atRisk.map(a=>a.name).join(', ') || 'None'}</strong></div>
    <div>• Avg engagement: <strong>${avgEngagement()}%</strong> — look at teams <strong>below 65%</strong></div>
  `;
}

/* -------------------------
   Conversational AI (local)
   - pattern matching + heuristics
--------------------------*/
const QN = {
  // map quick keywords to handlers
  patterns: [
    { re: /turnover|attrition|attrition rate/i, fn: ()=> {
      const rate = computeTurnover();
      return `Current simulated turnover (YTD) is ${rate}% of headcount. Top risk dept: ${topAttritionDept().dept}.`;
    }},
    { re: /which department has the highest attrition|highest attrition/i, fn: ()=> {
      const t = topAttritionDept();
      return `Based on engagement & tenure heuristics, *${t.dept}* shows the highest risk (score ${t.score}). Consider retention actions like mentoring and adjusted incentives.`;
    }},
    { re: /who is at risk|who.*risk.*leav/i, fn: ()=> {
      const list = atRiskEmployees(8);
      if(!list.length) return "No employees currently flagged as at-risk by the heuristic.";
      const out = list.map(e=> `${e.name} (${e.dept}) — Eng ${e.engagement}%, Tenure ${Math.round(e.tenureMonths/12)}y`).join("\n");
      return `Top at-risk employees:\n${out}\n\nRecommended actions: 1) 1:1 check-ins 2) manager coaching 3) retention package for key roles.`;
    }},
    { re: /time[- ]?to[- ]?hire|time to hire/i, fn: ()=> {
      const t = avgTimeToHire();
      const avgCost = Math.round(MOCK.jobs.reduce((s,j)=>s+j.costPerHire,0)/MOCK.jobs.length);
      return `Simulated avg time-to-hire: ${t} days. Simulated cost-per-hire (avg): ₦${avgCost.toLocaleString()}.`;
    }},
    { re: /cost[- ]?per[- ]?hire|cost per hire/i, fn: ()=> {
      const avgCost = Math.round(MOCK.jobs.reduce((s,j)=>s+j.costPerHire,0)/MOCK.jobs.length);
      return `Simulated cost-per-hire across open roles is about ₦${avgCost.toLocaleString()}.`;
    }},
    { re: /engagement|engage rate|engagement rate/i, fn: ()=> {
      const avg = avgEngagement();
      return `Average employee engagement is ${avg}%. Departments under 65% should be prioritized for pulse surveys and manager interventions.`;
    }},
    { re: /absente|absenteeism/i, fn: ()=> {
      const avgAbs = Math.round(MOCK.employees.reduce((s,e)=>s+e.absenteeism,0)/MOCK.employees.length);
      return `Average absenteeism (days/month) is ~${avgAbs}. Top offenders should be contacted for support; consider flexible scheduling.`;
    }},
    { re: /promotion|promot/i, fn: ()=> {
      const list = MOCK.employees.filter(e => e.promotionReady).slice(0,8);
      if(!list.length) return "No clear promotion-ready employees in mock data. Run performance reviews and confirm competencies.";
      return `Potential promotion-ready employees:\n${list.map(e=>`${e.name} — ${e.role} (${e.dept})`).join("\n")}. Recommend development plans & calibration.`;
    }},
    { re: /training effectiveness|training/i, fn: ()=> {
      const te = trainingEffectivenessSim();
      return `Training effectiveness (simulated):\n${te.map(t=>`${t.program} — participants ${t.participants}, impact +${t.impact}% performance`).join("\n")}\nTip: measure engagement & performance delta pre/post training.`;
    }},
    { re: /diversit|gender|inclusion|d&i/i, fn: ()=> {
      const byGender = MOCK.employees.reduce((acc,e)=>{ acc[e.gender]=(acc[e.gender]||0)+1; return acc; }, {});
      return `Diversity quick view (simulated): M: ${byGender['M']||0}, F: ${byGender['F']||0}. Use hiring targets to improve underrepresented groups in leadership.`;
    }},
    { re: /internal promotion rate|internal promot/i, fn: ()=> {
      // simulate
      const rate = Math.round((Math.random()*6 + 6));
      return `Simulated internal promotion rate: ~${rate}% per year (prototype). Track % promoted vs. external hires for key roles.`;
    }},
    { re: /predict|predict.*attrition|forecast attrition/i, fn: ()=> {
      // simple simulated prediction
      const top = topAttritionDept();
      return `Prediction (rule-based): ${top.dept} has rising attrition risk next quarter. Estimated increase: 3-8% if no intervention.`;
    }},
    { re: /who.*top performers|top performers/i, fn: ()=> {
      const t = topPerformers(6);
      return `Top performers (simulated):\n${t.map(x=>`${x.name} — ${x.role} (${x.dept}) — Perf ${x.performanceTrend}/5, Eng ${x.engagement}%`).join("\n")}`;
    }},
    // fallback: catch asking for charts / metrics
    { re: /show.*engagement|engagement trend/i, fn: ()=> {
      return `Rendered engagement trend chart above (6 months). Avg: ${avgEngagement()}%. Use pulse surveys to track sentiment more frequently.`;
    }},
    // default fallback function that tries to infer keywords
    { re: /.*/, fn: (q)=> {
      // simple heuristics: look for dept name
      const ql = q.toLowerCase();
      if(ql.includes('sales')) return `Sales note: engagement average in Sales is ${Math.round(MOCK.employees.filter(e=>e.dept==='Sales').reduce((s,e)=>s+e.engagement,0)/Math.max(1,MOCK.employees.filter(e=>e.dept==='Sales').length))}%. Consider quota review.`;
      if(ql.includes('engineering')) return `Engineering note: attrition risk moderate; consider improving onboarding & mentoring for juniors.`;
      // else general fallback
      return `I can compute turnover, engagement, time-to-hire, cost-per-hire, top at-risk employees, training effectiveness, and diversity metrics. Try: "Who is at risk of leaving?" or "Show time-to-hire".`;
    }}
  ],
  ask: function(q){
    for(const p of this.patterns){
      if(p.re.test(q)) return p.fn(q);
    }
    return "Sorry — I couldn't match that query.";
  }
};

/* -------------------------
   UI glue
--------------------------*/
function appendConvo(text, who='ai'){
  const c = document.getElementById('convo');
  const node = document.createElement('div');
  node.style.marginBottom = '8px';
  node.innerHTML = `<div class="p-2 ${who==='ai'?'bg-gray-100':'bg-indigo-600 text-white'} rounded">${text.replace(/\n/g,'<br>')}</div>`;
  c.appendChild(node);
  c.scrollTop = c.scrollHeight;
}

function ask(q){
  appendConvo(`<strong>You:</strong> ${q}`, 'user');
  // quick simulated thinking
  appendConvo('<em>Analyzing data...</em>', 'ai');
  setTimeout(()=> {
    // remove last analyzing line
    const conv = document.getElementById('convo');
    if(conv.lastChild && conv.lastChild.textContent.includes('Analyzing')) conv.removeChild(conv.lastChild);
    const resp = QN.ask(q);
    appendConvo(`<strong>Lumion Assistant:</strong> ${resp}`, 'ai');
  }, 700 + Math.random()*700);
}

/* Buttons and exports */
document.getElementById('askBtn').addEventListener('click', ()=> {
  const q = document.getElementById('askInput').value.trim();
  if(!q) return;
  ask(q);
  document.getElementById('askInput').value='';
});
document.getElementById('clearBtn').addEventListener('click', ()=> { document.getElementById('convo').innerHTML=''; });

document.getElementById('downloadData').addEventListener('click', ()=> {
  const zipData = { employees: MOCK.employees, jobs: MOCK.jobs, months: MOCK.months };
  const blob = new Blob([JSON.stringify(zipData, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'lumion_mock_data.json'; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById('exportEmployees').addEventListener('click', ()=> {
  const rows = [["id","name","dept","role","salary","start","tenureMonths","engagement","performanceTrend","status","absenteeism"]];
  MOCK.employees.forEach(e=> rows.push([e.id,e.name,e.dept,e.role,e.salary,e.start,e.tenureMonths,e.engagement,e.performanceTrend,e.status,e.absenteeism]));
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lumion_employees.csv'; a.click();
});

document.getElementById('exportJobs').addEventListener('click', ()=> {
  const rows=[["id","title","team","openDate","timeToHire","costPerHire"]];
  MOCK.jobs.forEach(j=> rows.push([j.id,j.title,j.team,j.openDate,j.timeToHire,j.costPerHire]));
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lumion_jobs.csv'; a.click();
});

document.getElementById('resetData').addEventListener('click', ()=> {
  if(!confirm('Reset demo & refresh page?')) return;
  location.reload();
});

/* chat floating UI (optional) */
document.getElementById('chatSend').addEventListener('click', ()=> {
  const v = document.getElementById('chatBox').value.trim(); if(!v) return;
  const m = document.getElementById('chatMessages');
  const u = document.createElement('div'); u.className='chat-bubble chat-user'; u.textContent=v; m.appendChild(u);
  document.getElementById('chatBox').value='';
  setTimeout(()=> {
    const a = document.createElement('div'); a.className='chat-bubble chat-ai'; a.textContent='Lumion Assistant (local): Try asking about turnover or at-risk employees.'; m.appendChild(a); m.scrollTop = m.scrollHeight;
  },600);
});

/* -------------------------
   Boot & render
--------------------------*/
document.addEventListener('DOMContentLoaded', ()=> {
  renderKPIs();
  renderCharts();
  renderDirectory();
  renderQuickInsights();
  // wire ask suggestions in right side
  document.querySelectorAll('.pill').forEach(btn=> {
    btn.addEventListener('click', ()=> ask(btn.textContent));
  });
  // sample initial greeting
  appendConvo('<strong>Lumion Assistant:</strong> Hello — ask me about turnover, engagement, hires, and at-risk employees. I run offline on the mock dataset.', 'ai');
});
</script>
</body>
</html>
